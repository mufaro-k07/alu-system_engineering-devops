#!/usr/bin/env bash
# Fix Nginx so it runs and listens on port 80 on all IPv4 addresses

# Fix the default site configuration to ensure it listens on port 80
CONF="/etc/nginx/sites-available/default"

# Make sure it listens on port 80 (IPv4 and IPv6) â€“ both buggy 8080 and correct 80 cases
sed -i 's/listen 80 default_server;/listen 80 default_server;/g' "$CONF"
sed -i 's/listen \[::\]:80 default_server;/listen [::]:80 default_server;/g' "$CONF"
sed -i 's/listen 8080 default_server;/listen 80 default_server;/g' "$CONF"
sed -i 's/listen \[::\]:8080 default_server;/listen [::]:80 default_server;/g' "$CONF"

# Ensure the site is enabled
if [ ! -e /etc/nginx/sites-enabled/default ]; then
    ln -s "$CONF" /etc/nginx/sites-enabled/default
fi

service nginx restart
