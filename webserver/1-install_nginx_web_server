#!/usr/bin/env bash
# Installs Nginx on Ubuntu 16.04, ensures it listens on port 80, and serves a page containing "Holberton School"

set -o nounset
set -o errexit
set -o pipefail

# Ensure apt is up to date and install nginx
export DEBIAN_FRONTEND=noninteractive
apt-get update -y
apt-get install -y nginx

# Make sure default server block listens on port 80 (fresh installs already do)
# This sed is safe/idempotent; it only updates existing 'listen' directives to 80.
if [ -f /etc/nginx/sites-available/default ]; then
  sed -i 's/^\s*listen\s\+[0-9]\{2,5\}\s*default_server;$/\tlisten 80 default_server;/' /etc/nginx/sites-available/default
  sed -i 's/^\s*listen\s\+\[::\]:[0-9]\{2,5\}\s*default_server;$/\tlisten [::]:80 default_server;/' /etc/nginx/sites-available/default
fi

# Provide the required content at the web root
mkdir -p /var/www/html
echo "Holberton School for the win!" > /var/www/html/index.html

# Test Nginx config, then (re)start without systemctl
nginx -t
service nginx restart
